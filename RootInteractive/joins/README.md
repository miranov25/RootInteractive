# RootInteractive/joins — CrossTableFilter Prototype (Phase 0.2.A)

Multi-table join primitives for RootInteractive: inverse index + parent→child filter propagation.

## Quick Start

```bash
# Generate fixture from Python oracle (requires Phase 0.1.F.ext)
cd ../Tools/generators && python generate_ao2d_fixture.py ../../joins/ao2d_fixture.json

# Run all tests
cd RootInteractive/joins
node --test test_*.mjs
```

## Architecture

**One new primitive — the inverse index:**

```
Forward (N:1 gather, existing):
  tracks.collisionId[i] → collisions row index
  "For each track, look up its parent"

Inverse (1:N filter, NEW):
  collisions[j] → [list of track indices where FK == j]
  "For each selected parent, find all children"
```

Two variants:
- **InverseIndexCSR** — works with unsorted FK (always correct)
- **SortedRangeIndex** — requires sorted FK (faster, 3–4× less memory)

## API

### `buildInverseIndex(fkArray, parentCount, options?)`

```javascript
import { buildInverseIndex, childrenOf } from "./buildInverseIndex.mjs";

const fk = new Int32Array([0, 0, 1, 1, 1, 2]);  // child → parent
const idx = buildInverseIndex(fk, 3);             // CSR (default)
const children = childrenOf(idx, 1);               // → [2, 3, 4]

// Sorted variant (FK must be non-decreasing)
const sIdx = buildInverseIndex(fk, 3, { sorted: true });
```

### `crossTableFilter(inverseIndex, selectedParents, childCount)`

```javascript
import { crossTableFilter, maskToIndices } from "./CrossTableFilter.mjs";

const mask = crossTableFilter(idx, new Int32Array([0, 2]), 6);
// → Uint8Array [1, 1, 0, 0, 0, 1]

const indices = maskToIndices(mask);  // → Int32Array [0, 1, 5]
```

### Cascade (3-level)

```javascript
const invTE = buildInverseIndex(tracksEventIdx, nEvents);
const invCT = buildInverseIndex(clustersTrackIdx, nTracks);

// Event 5 → its tracks → their clusters
const trackMask = crossTableFilter(invTE, new Int32Array([5]), nTracks);
const selectedTracks = maskToIndices(trackMask);
const clusterMask = crossTableFilter(invCT, selectedTracks, nClusters);
```

## Test Matrix

| Test | Description | Cross-Backend? |
|------|-------------|----------------|
| TC-INV-01 | InverseIndexCSR correctness | ✅ Python oracle |
| TC-INV-02 | SortedRangeIndex correctness | ✅ Python oracle |
| TC-INV-03 | CSR vs SortedRange invariance | ✅ Python oracle |
| TC-INV-04 | Sentinel handling (efficiency holes) | ✅ Python oracle |
| TC-INV-05 | Empty parent (0 children) | ✅ Python oracle |
| TC-CTF-01 | Single parent filter | ✅ Python oracle |
| TC-CTF-02 | Range filter (events 0–9) | ✅ Python oracle |
| TC-CTF-03 | Select all → all children | ✅ Python oracle |
| TC-CTF-04 | Select none → empty mask | JS-only |
| TC-CTF-05 | 3-level cascade (events→tracks→clusters) | ✅ Python oracle |
| TC-CTF-06 | M:N via junction (mc_labels) | ✅ Python oracle |
| TC-CTF-07 | Multi-reference (V0 dual FK) | DEFERRED |
| TC-CTF-08 | Round-trip invariance | ✅ Python oracle |
| TC-PERF-01 | SortedRange vs CSR performance | JS-only |
| TC-COMPAT-01 | N:1 gather semantics unchanged | JS-only |

**58 test assertions total. 11/14 active tests have cross-backend validation.**

## Performance (seed=42, 100 events)

| Metric | CSR | SortedRange | Ratio |
|--------|-----|-------------|-------|
| Build (674 tracks) | 0.07 ms | 0.04 ms | 2.0× |
| Build (38K clusters) | 0.42 ms | 0.12 ms | 3.4× |
| Query 1 parent | 0.002 ms | 0.002 ms | 1.1× |
| Query 100 parents | 0.004 ms | 0.003 ms | 1.4× |
| Memory (tracks→events) | 3,100 B | 800 B | 3.9× |

## Memory Budget (at scale)

| Scale | CSR | SortedRange |
|-------|-----|-------------|
| 5K tracks, 100 events | ~20 KB | ~0.8 KB |
| 5M tracks, 100K events | ~20 MB | ~0.8 MB |

## Files

| File | Description |
|------|-------------|
| `buildInverseIndex.mjs` | Core: CSR + SortedRangeIndex builders |
| `CrossTableFilter.mjs` | Core: parent selection → child mask |
| `ao2d_fixture.json` | Generated by Python oracle |
| `test_invariance.mjs` | Cross-backend invariance (MERGE GATE) |
| `test_inverse_index.mjs` | JS-internal inverse index tests |
| `test_cross_table_filter.mjs` | JS-internal filter tests |
| `test_performance.mjs` | SortedRange vs CSR benchmarks |
| `test_backward_compat.mjs` | N:1 gather unchanged |

## Dependencies

- **Node.js ≥ 18.x** (test runner)
- **Python ≥ 3.10** (fixture generation: numpy, pandas)
- **No npm packages** — pure typed arrays

## Phase Context

Phase 0.2.A validates the single new primitive (inverse index + CrossTableFilter) that enables 1:N, M:N, and cascade joins in RootInteractive. Future phases integrate this into the Bokeh/RI client-side pipeline.
